<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="favicon.ico">

    <title>Tafels oefenen</title>

    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="style.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="site-wrapper">

      <div class="site-wrapper-inner">

        <div class="cover-container">

          <div class="masthead clearfix">
            <div class="inner">
              <h3 class="masthead-brand">Tafels oefenen</h3>
              <ul class="nav masthead-nav">
                <li class="mode-1 active"><a href="#"><span class="glyphicon glyphicon-random"></span></a></li>
                <li class="mode-2"><a href="#">2</a></li>
                <li class="mode-3"><a href="#">3</a></li>
                <li class="mode-4"><a href="#">4</a></li>
                <li class="mode-5"><a href="#">5</a></li>
                <li class="mode-6"><a href="#">6</a></li>
                <li class="mode-7"><a href="#">7</a></li>
                <li class="mode-8"><a href="#">8</a></li>
                <li class="mode-9"><a href="#">9</a></li>
                <li class="mode-10"><a href="#">10</a></li>
              </ul>
            </div>
          </div>

          <div class="inner cover">
            <!-- #loading -->
            <div id="loading">
              <p>Bezig met laden...</p>
            </div>
            <!-- /#loading -->
            <!-- #intro -->
            <div id="intro"><p class="lead">Hoi! Tafels oefenen is niet altijd zo leuk, maar je leert er wel snel mee rekenen. Daarom krijg je na elke vijf juiste oplossingen hier een grappig filmpje te zien. Je kiest zelf welke tafels je wil oefenen, bovenaan de pagina. Opgelet! Telkens je daar een nieuwe tafel kiest, begint de teller weer van voren.</p>
              <div class="buttons">
                <button type="button" class="btn btn-lg btn-primary btn-tafel1" ><span class="glyphicon glyphicon-random"></span></button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel2" >2</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel3" >3</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel4" >4</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel5" >5</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel6" >6</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel7" >7</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel8" >8</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel9" >9</button>
                <button type="button" class="btn btn-lg btn-primary btn-tafel10" >10</button>
              </div>
            </div>
            <!-- /#intro -->
            <!-- #success -->
            <div id="outro-success"><p class="lead">Joechei! 't Is gedaan!</p>
            <button type="button" class="btn btn-lg btn-primary startbtn" >Opnieuw!</button>
            </div>
            <!-- /#success -->
            <!-- #fail -->
            <div id="outro-fail"><p class="lead">Oeps, dat duurde iets te lang!</p>
            <button type="button" class="btn btn-lg btn-primary startbtn" >Opnieuw!</button>
            </div>
            <!-- /#fail -->
            <!-- #gif -->
            <div id="intermission">
              <div id="gifholder">
                <img class="funnygif" src="funnygifs/cat1.gif" height="50%">
              </div>
              <button type="button" class="btn btn-lg btn-primary contbtn" >Verder</button>
            </div>
            <!-- /#gif -->
            <!-- # excercise -->
            <div id="excercise"><h1 class="cover-heading"><span id="firstpart"></span> x <span id="secondpart"></span> <span id="feedback"></span></h1>
            <table class="table table-bordered" id="honderdveld">
              <tr>
                <td>Bezig met laden...</td>
              </tr>
            </table>
            <!-- <button type="button" class="btn btn-lg btn-primary" id="nextbtn">Volgende</button> -->
          </div>
          <!-- /#excercise -->
          </div>

          <div class="mastfoot">
            <div class="inner" id="progress">
              <div id="orientation"><span id="currentex">1</span> van <span id="totalex">10</span></div>
              <div class="progress">
                <div id="countdownbar" class="progress-bar progress-bar-success" role="progressbar" style="width: 100%">
                </div>
              </div>
            </div>
             <div class="inner">
              Gemaakt door <a href="http://www.automaton.be/">Toon Van de Putte</a> - <a href="https://github.com/toonvandeputte/tafels-oefenen"><i class="fa fa-github"></i> project op Github</a> - Sommige gifs &copy; <a href="http://www.romain-laurent.com/">Romain Laurent</a>.
            </div>

          </div>


        </div>

      </div>

    </div>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.min.js"></script>
    <script>
    $( document ).ready(function() {
        $(document).bind("mobileinit", function() {
          $.mobile.defaultPageTransition = 'none';
          $.mobile.page.prototype.options.addBackBtn = true;
          $.mobile.useFastClick  = false;
        });
        $("#loading").hide();
        $("#intro").show();
        // begin initial data
        var countdowninterval = null;
        var multitables = [2,3,4,5,6,7,8,9,10];
        var multipliers = [1,2,3,4,5,6,7,8,9,10];
        var excounter = 0;
        var tablemode =1;
        var timetocount = 0;
        var timeleft = 0
        var timeperq = 4;
        var penalty = 2;
        var bonus = 1;
        var enabled = false;
        var playcounts = new Array();
        var funnygifs = new Array();
        $.getJSON("gifs.json", function(jsondata) {
            enabled = true;
            console.log(jsondata["funnygifs"]);
            $.each(jsondata["funnygifs"], function(key,entry){
              playcounts[entry]=0;
              funnygifs.push(entry)
            });
            console.log(funnygifs);
        });
        console.table(playcounts);
        // end initial data
        // begin mode selector
        for (m=1,mlen=10; m<=mlen;m++) {
          $("li.mode-"+m+" a").data( "mode", m );
          $("#intro .btn-tafel"+m).data( "mode", m );
          //console.log("mode set: "+$("#intro .btn-tafel"+m).data( "mode"));
          $("li.mode-"+m+" a").bind('click',function(){
            $(".masthead-nav li").removeClass("active");
            $(this).parent().addClass("active");
            tablemode = $(this).data("mode");
            startRun($(this).data("mode"));
            //console.log($(this).data("mode"));
          });
          $("#intro .btn-tafel"+m).bind('click',function(){
            //console.log("mode: "+$(this).data("mode"));
            $(".masthead-nav li").removeClass("active");
            $("li.mode-"+$(this).data("mode")).addClass("active");
            tablemode = $(this).data("mode");
            startRun($(this).data("mode"));
            //console.log($(this).data("mode"));
          });
        }
        // end mode selector
        function startRun(tablemode) {
          window.clearInterval(countdowninterval);
          excounter = 0;
          timetocount = 0;
          //console.log("tablemode: "+tablemode);
          $("#intro").hide();
          $("#intermission").hide();
          $("#outro-fail").hide();
          $("#outro-success").hide();
          $("#excercise").show();
          $("#progress").show();
          goTables(tablemode);
        }
        function drawField() {
          var fieldhtml ="";
          for(var row = 0, rlen = 10; row< rlen; row++) {
            fieldhtml+="<tr>";
            for(var cell = 1, clen = 10; cell<= clen; cell++) {
              var cellval=(row*10)+cell;
              var before="";
              var after="";
              var specialclass="";
              if (cellval%5===0) {
                var before="<strong>";
                var after="</strong>";
                var specialclass="hilite";
              }
              fieldhtml+="<td class='clickcell "+specialclass+"' id='cell"+cellval+"'>"+before+"<a class='celllink' data-value='"+cellval+"' href='?firstpart="+window.qtoshow[0].firstpart+"&secondpart="+window.qtoshow[0].secondpart+"&answer="+cellval+"'>"+cellval+"</a>"+after+"</td>";
            }
            fieldhtml+="</tr>";
          }
          $("#honderdveld").html(fieldhtml);
          $(".celllink").bind('click',function(event){
            event.preventDefault();
            $(".celllink").removeClass("hilite");
            $(this).addClass("hilite");
            var answerclicked = parseInt($(this).attr("data-value"));
            checkAnswer(answerclicked);
            //console.log($(this).attr("data-value"));
          });
          //console.log(fieldhtml);
        }
        function goTables(limit) {
            if (multitables.indexOf(limit) > -1) {
              var mytables = [limit];
              window.questions = [];
              for(var i = 0, len = mytables.length; i< len; i++) {
                var secondpart = mytables[i];
                for(var j = 0, jlen = multipliers.length; j< jlen; j++) {
                  var firstpart = multipliers[j];
                  var solution = firstpart*secondpart;
                  var thisquestion = Object.create(null);
                  thisquestion.firstpart = firstpart;
                  thisquestion.secondpart = secondpart;
                  thisquestion.solution = solution;
                  window.questions.push(thisquestion);
                }
              }
            } else {
              var mytables = multitables.slice(0);
              var mymultis = multipliers.slice(0);
              window.questions = [];
              for (var i=0;i<10;i++) {
                a=Math.floor(Math.random()*(mytables.length));
                b=Math.floor(Math.random()*(mymultis.length));
                var firstpart = mytables[a];
                var secondpart = mymultis.splice(b, 1)[0];
                /*console.log("--- "+i+" ---");
                console.log("firstpart: "+firstpart+"(el "+a+") "+mytables.length);
                console.log("secondpart: "+secondpart+"(el "+b+") "+mymultis.length);*/
                var solution = firstpart*secondpart;
                var thisquestion = Object.create(null);
                thisquestion.firstpart = firstpart;
                thisquestion.secondpart = secondpart;
                thisquestion.solution = solution;
                window.questions.push(thisquestion);
              }
              //var mytables = multitables;
              //console.log("all tables");
              //console.table(window.questions);
            }
            $("#totalex").html(window.questions.length);
            timetocount=window.questions.length*timeperq;
            timeleft = timetocount;
            updateBar();
            window.paused=false;
            countdowninterval = window.setInterval(trackTime,1000);
            getQuestion();
        }
        function continueRun() {
            $("#intermission").hide();
            $("#excercise").show();
            $("#progress").show();
            //countdowninterval = window.setInterval(trackTime,1000);
            window.paused=false;
        }
        function trackTime() {
              if (window.paused===false){
                timeleft--;
              }
              updateBar();
              //console.log("timeleft: "+timeleft+" / countdowninterval:"+countdowninterval+" / timetocount: "+timetocount+" / relval: "+relval);
        }
        function updateBar() {
            if (timeleft<0) {
                timeleft=0;
                if (window.questions.length>0) {
                  $("#excercise").hide();
                  $("#outro-fail").show();
                }
            }
            relval=(timeleft/timetocount)*100;
            //console.log(relval);
            $("#countdownbar").css("width",relval+"%");
        }
        function findagif(playcount) {
          if (playcount==undefined) {
            playcount=0;
          }
          mygif = funnygifs[Math.floor(Math.random()*funnygifs.length)];
          console.log("mygif: "+mygif);
          loopcounter=0;
          while (playcounts[mygif]!=playcount) {
            mygif = funnygifs[Math.floor(Math.random()*funnygifs.length)];
            loopcounter++;
            if (loopcounter>=funnygifs.length) {
              playcount++;
              loopcounter=0;
            }
          }
          //console.log("starting recursive function");
          /*findagif(playcount);*/
          return mygif;
        }
        function showIntermission(){
              //window.clearInterval(countdowninterval);
              window.paused=true;
              valtocheck=undefined;
              window.currentgif=findagif();
              console.log(window.currentgif);
              playcounts[mygif]+=1;
              console.table(playcounts);
              $("#progress").hide();
              $("#excercise").hide();
              $("#intermission").show();
              $("#gifholder").html('<img class="funnygif" src="funnygifs/'+window.currentgif+'" width="80%">');

              if (window.questions.length===0) {
                $(".contbtn").bind('click',function(){
                  window.clearInterval(countdowninterval);
                  //console.log("interval "+countdowninterval+" should be cleared");
                   $("#excercise").hide();
                   $("#outro-success").show();
                });
              } else {
                $(".contbtn").bind('click',function(){
                   continueRun();
                });
              }
        }
        function getQuestion(q) {
          if (window.questions.length===0) {
            $("#excercise").hide();
            $("#outro-success").show();
            window.clearInterval(countdowninterval);
            //console.log("interval "+countdowninterval+" should be cleared");
          } else {
            if (excounter%3===0&&excounter>0) {
              showIntermission();
            }
            excounter++;
            $("#currentex").html(excounter);
            //console.log("excounter: "+excounter);
            if (q===undefined || q < 0) {
              if (window.questions.length===1) {
                q=0;
              } else {
                q=Math.floor(Math.random()*(window.questions.length));
              }
            }
            //console.log("get question: "+q);
            window.qtoshow = window.questions.splice(q, 1);
            //console.log(qtoshow[0]);
            //console.log(qtoshow[0].firstpart);
            $("#firstpart").html(window.qtoshow[0].firstpart);
            $("#secondpart").html(window.qtoshow[0].secondpart);
            $("#feedback").html("<span class='glyphicon glyphicon-question-sign'></span>");
            drawField();
            $('#nextbtn').prop('disabled', true);
            //console.table(qtoshow);
          }
        }
        function checkAnswer(answer){
          //console.log(answer+" / "+window.qtoshow[0].solution);
          if (answer===window.qtoshow[0].solution) {
            timeleft+=bonus;
            //updateBar();
            $("#feedback").html("<span class='glyphicon glyphicon-ok-circle'></span>");
            //$('#nextbtn').prop('disabled', false);
            window.timeOutID=window.setTimeout(getQuestion,(bonus*1000));
          } else {
            //timeleft-=penalty;
            //updateBar();
            $("#feedback").html("<span class='glyphicon glyphicon-remove-circle'></span>");
            $('#nextbtn').prop('disabled', true);
          }
        }
        //initial button activate
        $(".startbtn").bind('click',function(){
          startRun(tablemode);
        });
        $(".contbtn").bind('click',function(){
          continueRun();
        });
        // next button action
        $('#nextbtn').bind('click',function(){
          getQuestion();
          //console.log(window.questions.length);
        });
    });
    </script>
  </body>
</html>
